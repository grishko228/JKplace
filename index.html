<!DOCTYPE html>
<html>
<head>
  <title>Pixel Map with Auth & Colors</title>
  <style>
    canvas {
      border: 1px solid #000;
      image-rendering: pixelated;
      cursor: crosshair;
    }
    #controls {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>üåç Real-time Pixel Map</h2>

  <div id="controls">
    <button id="loginBtn">üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <input type="color" id="colorPicker" value="#FF0000" />
    <span id="userInfo"></span>
  </div>

  <canvas id="board" width="500" height="250"></canvas>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>

  <script>
    // üîë –í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï –ò–ó FIREBASE
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const canvas = document.getElementById("board");
    const ctx = canvas.getContext("2d");
    const size = 5;
    const colorPicker = document.getElementById("colorPicker");
    const loginBtn = document.getElementById("loginBtn");
    const userInfo = document.getElementById("userInfo");

    // –§–æ–Ω (–∫–∞—Ä—Ç–∞)
    const bgImage = new Image();
    bgImage.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Equirectangular-projection.jpg/800px-Equirectangular-projection.jpg";

    bgImage.onload = () => {
      drawCanvas();
    };

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø–∏–∫—Å–µ–ª–µ–π
    function drawCanvas(data = {}) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);

      for (const [key, color] of Object.entries(data)) {
        const [x, y] = key.split(",");
        ctx.fillStyle = color;
        ctx.fillRect(x * size, y * size, size, size);
      }
    }

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ë–î
    db.ref("pixels").on("value", (snapshot) => {
      const data = snapshot.val();
      drawCanvas(data || {});
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞
    canvas.addEventListener("click", (e) => {
      const user = auth.currentUser;
      if (!user) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google");
        return;
      }

      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / size);
      const y = Math.floor((e.clientY - rect.top) / size);
      const color = colorPicker.value;

      db.ref("pixels/" + x + "," + y).set(color);
    });

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Google
    loginBtn.addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then((result) => {
          const user = result.user;
          userInfo.textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.displayName}`;
        })
        .catch((error) => {
          alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
        });
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
    auth.onAuthStateChanged((user) => {
      if (user) {
        userInfo.textContent = `–ü—Ä–∏–≤–µ—Ç, ${user.displayName}`;
      } else {
        userInfo.textContent = "";
      }
    });
  </script>
</body>
</html>
